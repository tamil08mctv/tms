{% extends 'TMS/storeadmin/base.html' %}
{% load static %}

{% block title %}Edit Product - {{ product.name }}{% endblock %}

{% block content %}
<div class="container-fluid py-4 py-md-5">
    <div class="row justify-content-center">
        <div class="col-12 col-xl-11">
            <div class="card border-0 shadow-lg rounded-4 overflow-hidden">
                <div class="card-header bg-success text-white text-center py-4">
                    <h3 class="mb-0 fw-bold fs-4">Edit Product</h3>
                    <small class="d-block opacity-90">{{ product.name }}</small>
                </div>

                <div class="card-body p-4 p-lg-5">
                    <form method="post" enctype="multipart/form-data">
                        {% csrf_token %}

                        <!-- PRODUCT INFORMATION -->
                        <div class="bg-white rounded-4 shadow-sm p-4 mb-4">
                            <h5 class="text-success fw-bold mb-4 border-bottom pb-3">Product Information</h5>
                            <div class="row g-4">
                                <div class="col-12">
                                    <label class="form-label fw-bold">Product Name</label>
                                    {{ form.name }}
                                </div>
                                <div class="col-12 col-md-6">
                                    <label class="form-label fw-bold">Category</label>
                                    {{ form.category }}
                                </div>
                                <div class="col-12">
                                    <label class="form-label fw-bold">Short Description</label>
                                    {{ form.short_desc }}
                                </div>
                                <div class="col-12">
                                    <label class="form-label fw-bold">Full Description</label>
                                    {{ form.description }}
                                </div>
                            </div>
                        </div>

                        <!-- PRICE & STATUS -->
                        <div class="row g-4 mb-4">
                            <div class="col-12 col-lg-6">
                                <div class="bg-white rounded-4 shadow-sm p-4 h-100">
                                    <h5 class="text-success fw-bold mb-4 border-bottom pb-3">Price & Offer</h5>
                                    <label class="form-label fw-bold text-primary">Price Style</label>
                                    <div class="mb-3">{{ form.price_style }}</div>
                                    <label class="form-label fw-bold text-danger">Regular Price (MRP)</label>
                                    <div class="mb-3">{{ form.regular_price }}</div>
                                    <label class="form-label fw-bold text-success">Offer / Deal Price</label>
                                    <div class="mb-3">{{ form.offer_price }}</div>
                                    <label class="form-label fw-bold text-warning">Deal End Date</label>
                                    <div class="mb-3">{{ form.deal_end_date }}</div>
                                </div>
                            </div>
                            <div class="col-12 col-lg-6">
                                <div class="bg-white rounded-4 shadow-sm p-4 h-100">
                                    <h5 class="text-success fw-bold mb-4 border-bottom pb-3">Status</h5>
                                    <div class="form-check form-switch mb-3">{{ form.is_featured }} <label class="form-check-label ms-3">{{ form.is_featured.label }}</label></div>
                                    <div class="form-check form-switch mb-3">{{ form.is_new }} <label class="form-check-label ms-3">{{ form.is_new.label }}</label></div>
                                    <div class="form-check form-switch">{{ form.in_stock }} <label class="form-check-label ms-3">{{ form.in_stock.label }}</label></div>
                                </div>
                            </div>
                        </div>

                        <!-- PRODUCT VIDEO -->
                        <div class="bg-white rounded-4 shadow-sm p-4 mb-4">
                            <h5 class="text-success fw-bold mb-4 border-bottom pb-3">Product Video</h5>
                            {% if product.video %}
                                <div class="mb-4 align-items-center">
                                    <video controls style="width:100%; max-height:300px;">
                                        <source src="{{ product.video.url }}" type="video/mp4">
                                        Your browser does not support video.
                                    </video>
                                </div>
                                <p class="mb-3"><strong>Current Video:</strong> {{ product.video.name|slice:"15:" }}</p>
                            {% else %}
                                <p class="text-muted mb-3">No video uploaded</p>
                            {% endif %}
                            <label class="form-label fw-bold">Replace Video (MP4 recommended)</label>
                            <input type="file" name="video" accept="video/*" class="form-control form-control-lg">
                            <small class="text-muted">Max 25MB recommended</small>
                        </div>

                        <!-- ADD MORE IMAGES -->
                        <div class="bg-white rounded-4 shadow-sm p-4 mb-4">
                            <h5 class="text-success fw-bold mb-4 border-bottom pb-3">Add More Images</h5>
                            <input type="file" name="extra_images" multiple accept="image/*" class="form-control form-control-lg">
                            <small class="text-muted d-block mt-2">Hold Ctrl (Windows) or Cmd (Mac) to select multiple images</small>
                        </div>

                        <!-- CURRENT IMAGES -->
                        {% if product.images.exists %}
                        <div class="bg-white rounded-4 shadow-sm p-4">
                            <h5 class="text-success fw-bold mb-4 border-bottom pb-3">Current Images ({{ product.images.count }})</h5>
                            <div class="row g-4" id="image-sortable">
                                {% for img in product.images.all %}
                                <div class="col-6 col-md-4 col-lg-3 image-item" data-id="{{ img.id }}">
                                    <div class="card border-0 shadow-sm h-100 hover-lift">
                                        <img src="{{ img.image.url }}" class="card-img-top" style="height:180px; object-fit:cover;">
                                        <div class="card-body p-3 d-flex flex-column gap-2">
                                            {% if img.is_main %}
                                                <span class="badge bg-primary w-100 py-2">MAIN IMAGE</span>
                                            {% else %}
                                                <button type="submit" name="main_image" value="{{ img.id }}" class="btn btn-outline-primary btn-sm w-100">Set as Main</button>
                                            {% endif %}
                                            <button type="submit" name="delete_image" value="{{ img.id }}"
                                                    onclick="return confirm('Delete this image permanently?')"
                                                    class="btn btn-danger btn-sm w-100">Delete</button>
                                            <input type="hidden" name="image_order" value="{{ img.id }}" class="order-input">
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                        {% endif %}

                        <!-- SAVE BUTTONS -->
                        <div class="d-flex flex-column flex-md-row gap-3 justify-content-end mt-5 pt-4 border-top">
                            <a href="{% url 'store_products' %}" class="btn btn-secondary btn-lg w-100 w-md-auto order-2 order-md-1">Cancel</a>
                            <button type="submit" class="btn btn-success btn-lg w-100 w-md-auto fw-bold order-1 order-md-2">SAVE ALL CHANGES</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
<script>
    new Sortable(document.getElementById('image-sortable'), {
        animation: 300,
        onEnd: function () {
            document.querySelectorAll('.image-item').forEach((item, index) => {
                item.querySelector('.order-input').value = item.dataset.id;
            });
        }
    });
</script>

<style>
    .hover-lift { transition: all 0.3s ease; }
    .hover-lift:hover { transform: translateY(-10px); box-shadow: 0 20px 40px rgba(0,0,0,0.2)!important; }
    .form-control, .form-select { border-radius: 12px !important; }
</style>
{% endblock %}