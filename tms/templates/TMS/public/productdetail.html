{% extends 'TMS/base.html' %}
{% load static %}
{% block title %}{{ product.name }} - {{ product.store.name }}{% endblock %}

{% block content %}
<div class="container my-5">
    <div class="row g-5">
        <!-- LEFT: IMAGE GALLERY WITH ZOOM + THUMBNAILS -->
        <div class="col-lg-5">
            <div class="sticky-top" style="top: 20px;">
                <!-- Main Image with Zoom -->
                <div class="position-relative overflow-hidden rounded shadow mb-3" id="zoomContainer">
                    <img id="mainImage" src="{{ product.images.first.image.url|default:'https://via.placeholder.com/600' }}"
                         class="img-fluid w-100" style="max-height: 550px; object-fit: contain; cursor: zoom-in; transition: transform 0.3s;"
                         alt="{{ product.name }}">
                    <div class="position-absolute top-0 start-0 p-3">
                        {% if product.is_deal_active %}
                        <span class="badge bg-danger fs-6 px-3 py-2">DEAL OF THE DAY</span>
                        {% elif product.discount_percent > 0 %}
                        <span class="badge bg-success fs-6 px-3 py-2">{{ product.discount_percent }}% OFF</span>
                        {% endif %}
                    </div>
                </div>

                <!-- Thumbnails -->
                <div class="row g-2">
                    {% for img in product.images.all %}
                    <div class="col-3">
                        <img src="{{ img.image.url }}" class="img-thumbnail border {% if forloop.first %}border-primary{% endif %} cursor-pointer"
                             style="height: 90px; object-fit: cover;"
                             onclick="document.getElementById('mainImage').src = this.src; this.parentElement.parentElement.querySelectorAll('img').forEach(i=>i.classList.remove('border-primary')); this.classList.add('border-primary')">
                    </div>
                    {% empty %}
                    <div class="col-12 text-center py-5 text-muted">No Images</div>
                    {% endfor %}
                </div>

                <!-- Video -->
                {% if product.video %}
                <div class="mt-4">
                    <video controls class="w-100 rounded shadow">
                        <source src="{{ product.video.url }}" type="video/mp4">
                        Your browser does not support video.
                    </video>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- RIGHT: PRODUCT INFO -->
        <div class="col-lg-7">
            <h1 class="display-6 fw-bold mb-3">{{ product.name }}</h1>

            <!-- Price Section - Flipkart Style -->
            <div class="d-flex align-items-center mb-3">
                {% if product.get_striked_price %}
                <span class="text-muted text-decoration-line-through fs-4 me-3">₹{{ product.regular_price|floatformat:0 }}</span>
                <span class="text-success fs-1 fw-bold me-3">₹{{ product.offer_price|floatformat:0 }}</span>
                <span class="badge bg-danger fs-5">{{ product.discount_percent }}% OFF</span>
                {% else %}
                <span class="text-success fs-1 fw-bold">₹{{ product.offer_price|floatformat:0|default:"Call for Price" }}</span>
                {% endif %}
            </div>

            <p class="lead text-dark mb-4">{{ product.short_desc }}</p>

            <!-- Store Info -->
            <div class="border rounded p-3 bg-light mb-4">
                <p class="mb-1"><strong>Store:</strong> {{ product.store.name }}</p>
                <p class="mb-1"><i class="fas fa-map-marker-alt text-danger"></i> {{ product.store.city }}</p>
                <p class="mb-0"><i class="fas fa-phone text-success"></i> {{ product.store.phone }}</p>
            </div>

            <!-- WHATSAPP BUTTON - MEESHO STYLE -->
            <a href="{{ whatsapp_url }}" target="_blank"
               class="btn btn-success btn-lg w-100 py-4 shadow-lg mb-4 text-white"
               style="background: linear-gradient(45deg, #25D366, #128C7E); font-size: 1.5rem; border: none;">
                <i class="fab fa-whatsapp fa-2x me-3"></i>
                <strong>SEND ENQUIRY NOW → BEST PRICE</strong>
                <br><small>Message opens instantly • 99% auto-send</small>
            </a>

            <!-- Quick Enquiry Form -->
            <div class="card border-0 shadow-sm">
                <div class="card-body">
                    <h5 class="card-title">Get This Product Fast</h5>
                    <form method="post">
                        {% csrf_token %}
                        <div class="mb-3">{{ form.customer_name }}</div>
                        <div class="mb-3">{{ form.phone }}</div>
                        <div class="mb-3">{{ form.city }}</div>
                        <button type="submit" class="btn btn-primary w-100 py-3">
                            <i class="fas fa-paper-plane"></i> Send Enquiry
                        </button>
                    </form>
                </div>
            </div>

            <!-- Specifications Table -->
            {% if product.specs %}
            <div class="mt-5">
                <h4>Specifications</h4>
                <table class="table table-bordered">
                    {% for key, value in product.specs.items %}
                    <tr>
                        <td class="bg-light"><strong>{{ key|title }}</strong></td>
                        <td>{{ value }}</td>
                    </tr>
                    {% endfor %}
                </table>
            </div>
            {% endif %}

            <!-- Full Description -->
            {% if product.description %}
            <div class="mt-5">
                <h4>Description</h4>
                <div class="border rounded p-4 bg-light">
                    {{ product.description|linebreaks }}
                </div>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- SIMILAR PRODUCTS - FULL WIDTH -->
    {% if similar %}
    <div class="mt-5 pt-5 border-top">
        <h2 class="text-center mb-5 text-primary">
            {% if product.subcategory %}More {{ product.subcategory.name }}{% else %}Similar Products{% endif %}
        </h2>
        <div class="row g-4">
            {% for p in similar %}
            <div class="col-md-3 col-6">
                <div class="card h-100 shadow-sm border-0 hover-card">
                    <div class="position-relative">
                        <img src="{{ p.images.first.image.url|default:'https://via.placeholder.com/300' }}"
                             class="card-img-top" style="height: 220px; object-fit: cover;">
                        {% if p.is_deal_active %}
                        <div class="ribbon ribbon-top-right"><span>DEAL</span></div>
                        {% endif %}
                    </div>
                    <div class="card-body text-center p-3">
                        <h6 class="card-title fw-bold">{{ p.name|truncatewords:8 }}</h6>
                        <div class="mb-2">
                            {% if p.get_striked_price %}
                            <small class="text-muted text-decoration-line-through">₹{{ p.regular_price }}</small><br>
                            <span class="text-danger fs-5 fw-bold">₹{{ p.offer_price }}</span>
                            <span class="badge bg-danger small">{{ p.discount_percent }}% OFF</span>
                            {% else %}
                            <span class="text-success fs-5 fw-bold">{{ p.get_price_display }}</span>
                            {% endif %}
                        </div>
                        <small class="text-muted d-block mb-2">{{ p.store.name }}</small>
                        <a href="/store/{{ p.store.slug }}/product/{{ p.slug }}/" 
                           class="btn btn-success btn-sm w-100">
                            <i class="fab fa-whatsapp"></i> Enquire
                        </a>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}
</div>

<!-- ZOOM SCRIPT + RIBBON CSS -->
<style>
    #zoomContainer:hover #mainImage { transform: scale(1.8); }
    .ribbon {
        position: absolute;
        right: -5px; top: 10px;
        background: #e91e63;
        color: white;
        padding: 5px 15px;
        font-size: 12px;
        font-weight: bold;
        z-index: 10;
    }
    .ribbon-top-right { transform: rotate(45deg); width: 100px; }
    .hover-card { transition: all 0.3s; }
    .hover-card:hover { transform: translateY(-5px); box-shadow: 0 10px 20px rgba(0,0,0,0.1)!important; }
</style>

<!-- AUTO OPEN WHATSAPP ON MOBILE -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
    if (isMobile) {
        setTimeout(() => {
            const waLink = document.querySelector('a[href*="wa.me"]');
            if (waLink) waLink.click();
        }, 2000);
    }
});
</script>
{% endblock %}